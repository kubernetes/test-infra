- job-template:
    name: 'pull-{suffix}'
    concurrent: true
    properties:
        - build-discarder:
            days-to-keep: 7
        - github:
            url: 'https://github.com/{repo-name}'
        - throttle:
            max-total: '{max-total}'
            max-per-node: 2
            option: project
        - raw:
            xml: |
                <com.cloudbees.plugins.JobPrerequisites plugin="slave-prerequisites@1.0">
                    <script>docker version; gcloud version</script>
                    <interpreter>shell script</interpreter>
                </com.cloudbees.plugins.JobPrerequisites>
    parameters:
        - string:
            name: ghprbPullId
        - string:
            name: ghprbTargetBranch
        # The test job tracks a run through the queue using the buildId parameter.
        - string:
            name: buildId
    wrappers:
        - e2e-credentials-binding
        - inject:
            properties-content: |
                GOROOT=/usr/local/go
                GOPATH=$WORKSPACE/go
                PATH=$PATH:$GOROOT/bin:$WORKSPACE/go/bin
        - workspace-cleanup:
            dirmatch: true
            exclude: ['go/src/k8s.io/kubernetes/.git/']
            external-deletion-command: 'sudo rm -rf %s'
        - timeout:
            timeout: 90
            fail: true
    builders:
        - shell: |
            # TODO(fejta): consider a stable tag instead of master
            git clone https://github.com/kubernetes/test-infra -b master
            './test-infra/jenkins/bootstrap.py' --job='{job-name}' --repo=k8s.io/kubernetes --pull="${{ghprbPullId}}" --root="${{GOPATH}}/src"

- project:
    name: bootstrap-pull-jobs
    suffix:  # pull-<repo>-<suffix> is the expected format
      - kubernetes-cross:
          max-total: 12
          job-name: pull-kubernetes-cross
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-e2e-gce:
          max-total: 12
          job-name: pull-kubernetes-e2e-gce
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-e2e-gce-cri:
          max-total: 12
          job-name: pull-kubernetes-e2e-gce-cri
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-e2e-gce-gci:
          max-total: 12
          job-name: pull-kubernetes-e2e-gce-gci
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-e2e-gce-etcd3:
          max-total: 12
          job-name: pull-kubernetes-e2e-gce-etcd3
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-e2e-gke:
          max-total: 12
          job-name: pull-kubernetes-e2e-gke
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-e2e-gke-gci:
          max-total: 12
          job-name: pull-kubernetes-e2e-gke-gci
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-federation-e2e-gce:
          max-total: 12
          job-name: pull-kubernetes-federation-e2e-gce
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-federation-e2e-gce-gci:
          max-total: 12
          job-name: pull-kubernetes-federation-e2e-gce-gci
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-kubemark-e2e-gce:
          max-total: 12
          job-name: pull-kubernetes-kubemark-e2e-gce
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-kubemark-e2e-gce-gci:
          max-total: 12
          job-name: pull-kubernetes-kubemark-e2e-gce-gci
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-node-e2e:
          max-total: 12
          job-name: pull-kubernetes-node-e2e
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-node-e2e-cri:
          max-total: 12
          job-name: pull-kubernetes-node-e2e-cri
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-verify:
          max-total: 12
          job-name: pull-kubernetes-verify
          repo-name: 'kubernetes/kubernetes'
      - kubernetes-unit:
          max-total: 12
          job-name: pull-kubernetes-unit
          repo-name: 'kubernetes/kubernetes'
    jobs:
        - 'pull-{suffix}'
