---
periodics:

- name: ci-etcd-e2e-arm64
  interval: 4h
  cluster: k8s-infra-prow-build
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-dashboards: sig-etcd-periodics, sig-etcd-arm64
    testgrid-tab-name: ci-etcd-e2e-arm64
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        set -euo pipefail
        VERBOSE=1 GOOS=linux GOARCH=arm64 CPU=4 EXPECT_DEBUG=true make test-e2e-release
      resources:
        requests:
          cpu: "4"
          memory: "8Gi"
        limits:
          cpu: "4"
          memory: "8Gi"
    nodeSelector:
      kubernetes.io/arch: arm64

- name: ci-etcd-e2e-amd64
  interval: 4h
  cluster: eks-prow-build-cluster
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-dashboards: sig-etcd-periodics, sig-etcd-amd64
    testgrid-tab-name: ci-etcd-e2e-amd64
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        set -euo pipefail
        VERBOSE=1 GOOS=linux GOARCH=amd64 CPU=4 EXPECT_DEBUG=true make test-e2e-release
      resources:
        requests:
          cpu: "4"
          memory: "8Gi"
        limits:
          cpu: "4"
          memory: "8Gi"
    nodeSelector:
      kubernetes.io/arch: amd64

- name: ci-etcd-unit-test-amd64
  interval: 4h
  cluster: eks-prow-build-cluster
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-dashboards: sig-etcd-periodics
    testgrid-tab-name: ci-etcd-unit-test-amd64
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - make
      - test-unit
      resources:
        requests:
          cpu: "4"
          memory: "4Gi"
        limits:
          cpu: "4"
          memory: "4Gi"
    nodeSelector:
      kubernetes.io/arch: amd64

- name: ci-etcd-robustness-main-amd64
  interval: 24h
  cluster: k8s-infra-prow-build
  decorate: true
  decoration_config:
    timeout: 210m
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-create-test-group: 'true'
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        result=0
        apt-get -o APT::Update::Error-Mode=any update && apt-get --yes install cmake libfuse3-dev libfuse3-3 fuse3
        sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf
        make install-lazyfs
        set -euo pipefail
        GO_TEST_FLAGS="-v --count 120 --timeout '200m' --run TestRobustnessExploratory"
        VERBOSE=1 GOOS=linux GOARCH=amd64 CPU=8 EXPECT_DEBUG=true GO_TEST_FLAGS=${GO_TEST_FLAGS} RESULTS_DIR=/data/results make test-robustness-main || result=$?
        if [ -d /data/results ]; then
          zip -r ${ARTIFACTS}/results.zip /data/results
        fi
        exit $result
      resources:
        requests:
          cpu: "7"
          memory: "14Gi"
        limits:
          cpu: "7"
          memory: "14Gi"
      # fuse needs privileged mode
      securityContext:
        privileged: true
    nodeSelector:
      kubernetes.io/arch: amd64

- name: ci-etcd-robustness-main-arm64
  interval: 24h
  cluster: k8s-infra-prow-build
  decorate: true
  decoration_config:
    timeout: 210m
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-create-test-group: 'true'
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        result=0
        apt-get -o APT::Update::Error-Mode=any update && apt-get --yes install cmake libfuse3-dev libfuse3-3 fuse3
        sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf
        make install-lazyfs
        set -euo pipefail
        GO_TEST_FLAGS="-v --count 120 --timeout '200m' --run TestRobustnessExploratory"
        VERBOSE=1 GOOS=linux GOARCH=arm64 CPU=8 EXPECT_DEBUG=true GO_TEST_FLAGS=${GO_TEST_FLAGS} RESULTS_DIR=/data/results make test-robustness-main || result=$?
        if [ -d /data/results ]; then
          zip -r ${ARTIFACTS}/results.zip /data/results
        fi
        exit $result
      resources:
        requests:
          cpu: "7"
          memory: "14Gi"
        limits:
          cpu: "7"
          memory: "14Gi"
      # fuse needs privileged mode
      securityContext:
        privileged: true
    nodeSelector:
      kubernetes.io/arch: arm64

- name: ci-etcd-robustness-release35-amd64
  interval: 24h
  cluster: k8s-infra-prow-build
  decorate: true
  decoration_config:
    timeout: 210m
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-create-test-group: 'true'
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        result=0
        apt-get -o APT::Update::Error-Mode=any update && apt-get --yes install cmake libfuse3-dev libfuse3-3 fuse3
        sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf
        make install-lazyfs
        set -euo pipefail
        GO_TEST_FLAGS="-v --count 120 --timeout '200m' --run TestRobustnessExploratory"
        VERBOSE=1 GOOS=linux GOARCH=amd64 CPU=8 EXPECT_DEBUG=true GO_TEST_FLAGS=${GO_TEST_FLAGS} RESULTS_DIR=/data/results make test-robustness-release-3.5 || result=$?
        if [ -d /data/results ]; then
          zip -r ${ARTIFACTS}/results.zip /data/results
        fi
        exit $result
      resources:
        requests:
          cpu: "7"
          memory: "14Gi"
        limits:
          cpu: "7"
          memory: "14Gi"
      # fuse needs privileged mode
      securityContext:
        privileged: true
    nodeSelector:
      kubernetes.io/arch: amd64

- name: ci-etcd-robustness-release35-arm64
  interval: 24h
  cluster: k8s-infra-prow-build
  decorate: true
  decoration_config:
    timeout: 210m
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-create-test-group: 'true'
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        result=0
        apt-get -o APT::Update::Error-Mode=any update && apt-get --yes install cmake libfuse3-dev libfuse3-3 fuse3
        sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf
        make install-lazyfs
        set -euo pipefail
        GO_TEST_FLAGS="-v --count 120 --timeout '200m' --run TestRobustnessExploratory"
        VERBOSE=1 GOOS=linux GOARCH=arm64 CPU=8 EXPECT_DEBUG=true GO_TEST_FLAGS=${GO_TEST_FLAGS} RESULTS_DIR=/data/results make test-robustness-release-3.5 || result=$?
        if [ -d /data/results ]; then
          zip -r ${ARTIFACTS}/results.zip /data/results
        fi
        exit $result
      resources:
        requests:
          cpu: "7"
          memory: "14Gi"
        limits:
          cpu: "7"
          memory: "14Gi"
      # fuse needs privileged mode
      securityContext:
        privileged: true
    nodeSelector:
      kubernetes.io/arch: arm64

- name: ci-etcd-robustness-release34-amd64
  interval: 24h
  cluster: k8s-infra-prow-build
  decorate: true
  decoration_config:
    timeout: 210m
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-create-test-group: 'true'
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        result=0
        apt-get -o APT::Update::Error-Mode=any update && apt-get --yes install cmake libfuse3-dev libfuse3-3 fuse3
        sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf
        make install-lazyfs
        set -euo pipefail
        GO_TEST_FLAGS="-v --count 120 --timeout '200m' --run TestRobustnessExploratory"
        VERBOSE=1 GOOS=linux GOARCH=amd64 CPU=8 EXPECT_DEBUG=true GO_TEST_FLAGS=${GO_TEST_FLAGS} RESULTS_DIR=/data/results make test-robustness-release-3.4 || result=$?
        if [ -d /data/results ]; then
          zip -r ${ARTIFACTS}/results.zip /data/results
        fi
        exit $result
      resources:
        requests:
          cpu: "7"
          memory: "14Gi"
        limits:
          cpu: "7"
          memory: "14Gi"
      # fuse needs privileged mode
      securityContext:
        privileged: true
    nodeSelector:
      kubernetes.io/arch: amd64

- name: ci-etcd-robustness-release34-arm64
  interval: 24h
  cluster: k8s-infra-prow-build
  decorate: true
  decoration_config:
    timeout: 210m
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-create-test-group: 'true'
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        result=0
        apt-get -o APT::Update::Error-Mode=any update && apt-get --yes install cmake libfuse3-dev libfuse3-3 fuse3
        sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf
        make install-lazyfs
        set -euo pipefail
        GO_TEST_FLAGS="-v --count 120 --timeout '200m' --run TestRobustnessExploratory"
        VERBOSE=1 GOOS=linux GOARCH=arm64 CPU=8 EXPECT_DEBUG=true GO_TEST_FLAGS=${GO_TEST_FLAGS} RESULTS_DIR=/data/results make test-robustness-release-3.4 || result=$?
        if [ -d /data/results ]; then
          zip -r ${ARTIFACTS}/results.zip /data/results
        fi
        exit $result
      resources:
        requests:
          cpu: "7"
          memory: "14Gi"
        limits:
          cpu: "7"
          memory: "14Gi"
      # fuse needs privileged mode
      securityContext:
        privileged: true
    nodeSelector:
      kubernetes.io/arch: arm64

- name: ci-etcd-integration-1-cpu-amd64
  interval: 24h
  cluster: eks-prow-build-cluster
  decorate: true
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-dashboards: sig-etcd-periodics, sig-etcd-arm64
    testgrid-tab-name: ci-etcd-integration-1-cpu-amd64
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        set -euo pipefail
        make gofail-enable
        export JUNIT_REPORT_DIR=${ARTIFACTS}
        GOOS=linux GOARCH=amd64 CPU=1 make test-integration
      resources:
        requests:
          cpu: "2"
          memory: "3Gi"
        limits:
          cpu: "2"
          memory: "3Gi"

- name: ci-etcd-integration-1-cpu-arm64
  interval: 24h
  cluster: k8s-infra-prow-build
  decorate: true
  extra_refs:
    - org: etcd-io
      repo: etcd
      base_ref: main
  annotations:
    testgrid-dashboards: sig-etcd-periodics, sig-etcd-arm64
    testgrid-tab-name: ci-etcd-integration-1-cpu-arm64
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20241230-3006692a6f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - |
        set -euo pipefail
        make gofail-enable
        export JUNIT_REPORT_DIR=${ARTIFACTS}
        GOOS=linux GOARCH=arm64 CPU=1 make test-integration
      resources:
        requests:
          cpu: "2"
          memory: "3Gi"
        limits:
          cpu: "2"
          memory: "3Gi"
    nodeSelector:
      kubernetes.io/arch: arm64
