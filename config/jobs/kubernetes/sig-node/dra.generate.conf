[DEFAULT]
# `template` is a mandatory field that specifies the job template to use
template = dra.jinja
# `files` is a mandatory comma separated list of pairs <suffix>:<job name template> which
# specifies which YAML files and job names need to be generated.
# The name of each generated file is `<base name of template>-<suffix>.yaml`, for example dra-canary.yaml.
# The name of each generated job is made by substituting `{section}` placeholder with section name, e.g. ci-kind-dra.
files = canary:pull-kubernetes-{section}-canary,presubmit:pull-kubernetes-{section},ci:ci-{section}
# k8s-infra-prow-build is required for node jobs
# attempt to run node jobs on eks-prow-build-cluster fails
# with "boskos failed to acquire project: resources not found" error
cluster = k8s-infra-prow-build
interval = 6h
testgrid_dashboards = sig-node-dynamic-resource-allocation
testgrid_alert_email = eduard.bartosh@intel.com, patrick.ohly@intel.com
# Overall job timeout.
timeout = 90m
# Time for e2e_node Ginkgo run.
# Must be sufficiently smaller than the overall job timeout to leave time
# for test setup (compilation, deploying VM) and collecting results.
e2e_node_timeout = 60m
label_filter = Feature: containsAny DynamicResourceAllocation && Feature: isSubsetOf { Beta, DynamicResourceAllocation } && !Flaky && !Slow

# This jobs runs e2e.test with a focus on tests for the Dynamic Resource Allocation feature (currently beta)
# on a kind cluster with containerd updated to a version with CDI support.
[kind-dra]
description = Runs E2E tests for Dynamic Resource Allocation beta features against a Kubernetes master cluster created with sigs.k8s.io/kind
use_dind = true
cluster = eks-prow-build-cluster
run_if_changed = /(dra|dynamicresources|resourceclaim|deviceclass|resourceslice|resourceclaimtemplate|dynamic-resource-allocation|pkg/apis/resource|api/resource)/.*.go

# This jobs runs e2e.test with a focus on tests for the Dynamic Resource Allocation feature (currently alpha, soon beta)
# on a kind cluster with containerd updated to a version with CDI support.
#
# Compared to ci-kind-dra, this one enables all DRA-related features.
[kind-dra-all]
description = Runs E2E tests for Dynamic Resource Allocation alpha and beta features against a Kubernetes master cluster created with sigs.k8s.io/kind
cluster = eks-prow-build-cluster
all_features = true
use_dind = true
run_if_changed = /(dra|dynamicresources|resourceclaim|deviceclass|resourceslice|resourceclaimtemplate|dynamic-resource-allocation|pkg/apis/resource|api/resource)/.*.go

# This job runs e2e_node.test with a focus on tests for the Dynamic Resource Allocation feature (currently beta)
[node-e2e-crio-cgrpv1-dra]
job_type = node
description = Runs E2E node tests for Dynamic Resource Allocation beta features with CRI-O using cgroup v1
image_config_file = /home/prow/go/src/k8s.io/test-infra/jobs/e2e_node/crio/latest/image-config-cgroupv1-serial.yaml
inject_ssh_public_key = true
# Automatically testing with one container runtime in one configuration is sufficient to detect basic problems in kubelet early.
# CRI-O was picked because it was solid for testing so far.
run_if_changed = (/dra/|/dynamicresources/|/resourceclaim/|/deviceclass/|/resourceslice/|/resourceclaimtemplate/|/dynamic-resource-allocation/|/pkg/apis/resource/|/api/resource/|/test/e2e_node/dra_).*\.(go|yaml)

# This job is the same as ci-node-e2e-cgrpv1-crio-dra, but for cgroup v2
[node-e2e-crio-cgrpv2-dra]
job_type = node
description = Runs E2E node tests for Dynamic Resource Allocation beta features with CRI-O using cgroup v2
image_config_file = /home/prow/go/src/k8s.io/test-infra/jobs/e2e_node/crio/latest/image-config-cgroupv2-serial.yaml
inject_ssh_public_key = true

# This job runs the same tests as ci-node-e2e-crio-dra with Containerd 1.7 runtime
[node-e2e-containerd-1-7-dra]
job_type = node
description = Runs E2E node tests for Dynamic Resource Allocation beta features with containerd
image_config_file = /home/prow/go/src/k8s.io/test-infra/jobs/e2e_node/dra/image-config-containerd-1.7.yaml
