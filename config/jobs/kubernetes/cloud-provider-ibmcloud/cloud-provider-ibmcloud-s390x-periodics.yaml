periodics:
  - name: ci-kubernetes-unit-s390x
    interval: 1h
    cluster: k8s-infra-s390x-prow-build
    decorate: true
    extra_refs:
      - org: kubernetes
        repo: kubernetes
        base_ref: master
        path_alias: k8s.io/kubernetes
    annotations:
      testgrid-dashboards: ibm-s390x-periodics, ibm-s390x-k8s
      testgrid-tab-name: ci-kubernetes-unit-s390x
    spec:
      # unit tests have no business requiring root or doing privileged operations
      securityContext:
        # NOTE: these are arbitrary non-root values. They don't exist in the
        # image and don't need to, the unit tests should only write to TMPDIR
        runAsGroup: 2010
        runAsUser: 2001
      containers:
        - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20260120-e2c483ffe9-master
          command:
            - make
            - test
          env:
            - name: KUBE_TIMEOUT
              value: "-timeout=300s"
          securityContext:
            allowPrivilegeEscalation: false
          resources:
            requests:
              cpu: 6
              memory: "28Gi"
            limits:
              cpu: 6
              memory: "28Gi"

  - name: ci-kubernetes-integration-master-s390x
    interval: 1h
    cluster: k8s-infra-s390x-prow-build
    decorate: true
    extra_refs:
    - org: kubernetes
      repo: kubernetes
      base_ref: master
      path_alias: k8s.io/kubernetes
    annotations:
      testgrid-dashboards: ibm-s390x-k8s, ibm-s390x-periodics
      testgrid-tab-name: ci-kubernetes-integration-master-s390x
      description: "Ends up running: make test-integration"
    spec:
      containers:
      - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20260120-e2c483ffe9-master
        command:
        - runner.sh
        args:
        - ./hack/jenkins/test-integration-dockerized.sh
        env:
        - name: SHORT
          value: --short=false
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          limits:
            cpu: 6
            memory: 20Gi
          requests:
            cpu: 6
            memory: 20Gi

  - name: ci-kubernetes-integration-1-34-s390x
    interval: 6h # bump to 24h after initial debugging
    cluster: k8s-infra-s390x-prow-build
    decorate: true
    extra_refs:
    - org: kubernetes
      repo: kubernetes
      base_ref: release-1.34
      path_alias: k8s.io/kubernetes
    annotations:
      testgrid-dashboards: ibm-s390x-k8s, ibm-s390x-periodics
      testgrid-tab-name: ci-kubernetes-integration-1.34-s390x
      description: "Ends up running: make test-integration"
    spec:
      containers:
      - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20260120-e2c483ffe9-master
        command:
        - runner.sh
        args:
        - ./hack/jenkins/test-integration-dockerized.sh
        env:
        - name: SHORT
          value: --short=false
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          limits:
            cpu: 6
            memory: 20Gi
          requests:
            cpu: 6
            memory: 20Gi

  - name: ci-kubernetes-integration-1-33-s390x
    interval: 6h # bump to 24h after initial debugging
    cluster: k8s-infra-s390x-prow-build
    decorate: true
    extra_refs:
    - org: kubernetes
      repo: kubernetes
      base_ref: release-1.33
      path_alias: k8s.io/kubernetes
    annotations:
      testgrid-dashboards: ibm-s390x-k8s, ibm-s390x-periodics
      testgrid-tab-name: ci-kubernetes-integration-1.33-s390x
      description: "Ends up running: make test-integration"
    spec:
      containers:
      - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20260120-e2c483ffe9-master
        command:
        - runner.sh
        args:
        - ./hack/jenkins/test-integration-dockerized.sh
        env:
        - name: SHORT
          value: --short=false
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          limits:
            cpu: 6
            memory: 20Gi
          requests:
            cpu: 6
            memory: 20Gi

  - name: ci-kubernetes-s390x-conformance-latest-kubetest2
    cron: "0 2-23/3 * * *" # every 3h starting at 02:00 UTC
    cluster: k8s-infra-s390x-prow-build
    labels:
      preset-ibmcloud-cred-z: "true"
    decorate: true
    decoration_config:
      timeout: 220m
    extra_refs:
      - base_ref: main
        org: kubernetes-sigs
        repo: provider-ibmcloud-test-infra
        workdir: true
    annotations:
      description: Runs conformance tests using kubetest2 against kubernetes ci latest on IBM VPC
      testgrid-dashboards: ibm-s390x-k8s, conformance-s390x, ibm-k8s-e2e
      testgrid-tab-name: ci-kubernetes-s390x-conformance-latest-kubetest2
    spec:
      containers:
        - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20260120-e2c483ffe9-master
          securityContext:
            privileged: true
          env:
            - name: "BOSKOS_HOST"
              value: "boskos.test-pods.svc.cluster.local"
            - name: "USER"
              value: "ci-kubernetes-s390x-conformance-latest-kubetest2"
          resources:
            requests:
              cpu: 4
              memory: "14Gi"
            limits:
              cpu: 4
              memory: "14Gi"
          command:
            - runner.sh
          args:
            - bash
            - -c
            - |
              set -o xtrace
              set +o errexit
              export PATH=$GOPATH/bin:$PATH
              export GO111MODULE=on
              RESOURCE_TYPE="vpc-service"

              #Call to boskos to checkout resource
              heartbeat_account(){
                count=0
                url="http://${BOSKOS_HOST}/update?name=${BOSKOS_RESOURCE_NAME}&state=busy&owner=${USER}"
                while [ ${count} -lt 120 ]
                do
                  status_code=$(curl -s -o /dev/null -w '%{http_code}' -X POST ${url})
                  if [[ ${status_code} != 200 ]]; then
                    echo "Heart beat to resource '${BOSKOS_RESOURCE_NAME}' failed due to invalid response, status code: ${status_code}"
                    exit 1
                  fi
                  count=$(( $count + 1 ))
                  sleep 60
                done
              }

              if [ -n "${BOSKOS_HOST:-}" ]; then
                set +o xtrace
                url="http://${BOSKOS_HOST}/acquire?type=${RESOURCE_TYPE}&state=free&dest=busy&owner=${USER}"
                output=$(curl -v -X POST ${url})
                [ $? = 0 ] && status_code=200

                if [[ ${status_code} == 200 && ${output} =~ "failed" ]]; then
                  echo "Failed to acquire resource from Boskos of type ${RESOURCE_TYPE}"
                  exit 1
                elif [[ ${status_code} == 200 ]]; then
                  export BOSKOS_RESOURCE_NAME=$(echo ${output} | jq -r '.name')
                  export BOSKOS_REGION=$(echo ${output} | jq -r '.userdata["region"]')
                  export BOSKOS_RESOURCE_GROUP=$(echo ${output} | jq -r '.userdata["resource-group-name"]')
                  export BOSKOS_ZONE=$(echo ${output} | jq -r '.userdata["zone"]')
                  export BOSKOS_SUBNET_NAME=$(echo ${output} | jq -r '.userdata["subnet-name"]')
                  export BOSKOS_SUBNET_ID=$(echo ${output} | jq -r '.userdata["subnet-id"]')
                  rm -rf output.json
                else
                  echo "Failed to acquire resource due to invalid response, status code : ${status_code}"
                  exit 1
                fi
                heartbeat_account >> "$ARTIFACTS/boskos.log" 2>&1 &
                HEART_BEAT_PID=$(echo $!)
              fi

              #Setup of kubetest2 tf deployer and ginkgo tester
              make install-deployer-tf
              go install sigs.k8s.io/kubetest2/kubetest2-tester-ginkgo@latest

              CLUSTER_NAME="config1-$(date +%s)"
              kubetest2 tf  --target-provider vpc  --vpc-node-image-name ibm-ubuntu-22-04-4-minimal-s390x-3 --boskos-resource-type vpc \
              --vpc-region ${BOSKOS_REGION} --vpc-zone ${BOSKOS_ZONE} --vpc-subnet ${BOSKOS_SUBNET_NAME}\
              --vpc-name ${BOSKOS_RESOURCE_NAME} \
              --vpc-resource-group ${BOSKOS_RESOURCE_GROUP} \
              --vpc-ssh-key k8s-s390x-prow-ssh-key \
              --vpc-node-profile bz2-4x16 \
              --ssh-private-key /etc/secret-volume/ssh-privatekey \
              --extra-vars=k8s_tar_bundles:kubernetes-server-linux-s390x.tar.gz \
              --extra-vars=pod_subnet:10.244.0.0/16 \
              --extra-vars=cni_provider:flannel \
              --build-version $(curl -Ls https://dl.k8s.io/ci/latest.txt) \
              --cluster-name $CLUSTER_NAME \
              --workers-count 2 \
              --up --auto-approve --retry-on-tf-failure 3 \
              --break-kubetest-on-upfail true \
              --build-version $(curl -Ls https://dl.k8s.io/ci/latest.txt) \
              --test=ginkgo -- --parallel 10 --test-package-dir ci --test-package-marker latest.txt --focus-regex='\[Conformance\]' --skip-regex='\[Serial\]'; rc1=$?
              export KUBECONFIG="$(pwd)/$CLUSTER_NAME/kubeconfig"
              export ARTIFACTS=$ARTIFACTS/serial_tests_artifacts
              #Run Serial Conformance tests
              kubetest2 tf --target-provider vpc --vpc-region ${BOSKOS_REGION} --vpc-zone ${BOSKOS_ZONE} \
                --ignore-cluster-dir true \
                --cluster-name $CLUSTER_NAME \
                --down --auto-approve --ignore-destroy-errors \
                --test=ginkgo -- --test-package-dir ci \
                --test-package-marker latest.txt --focus-regex='\[Serial\].*\[Conformance\]'; rc2=$?
              if [ -n "${BOSKOS_HOST:-}" ]; then
                url="http://${BOSKOS_HOST}/release?name=${BOSKOS_RESOURCE_NAME}&dest=dirty&owner=${USER}"
                status_code=$(curl -w '%{http_code}' -X POST ${url})
                if [[ ${status_code} != 200 ]]; then
                  echo "Failed to release resource: ${BOSKOS_RESOURCE_NAME}"
                  exit 1
                fi
              fi

              if [ $rc1 != 0 ]; then
                  echo "ERROR: Non Serial k8s Conformance tests exited with code: $rc1"
                  exit $rc1
              elif [ $rc2 != 0 ]; then
                  echo "ERROR: Serial k8s Conformance tests exited with code: $rc2"
                  exit $rc2
              fi
