periodics:
- interval: 1h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind
  annotations:
    testgrid-dashboards: sig-release-master-blocking, sig-testing-kind
    testgrid-tab-name: kind-master
    description: Uses kubetest to run e2e tests for on-by-default features against a latest kubernetes master cluster created with sigs.k8s.io/kind
    testgrid-alert-email: bentheelder@google.com,antonio.ojea.garcia@gmail.com,release-team@kubernetes.io
    testgrid-num-columns-recent: '6'
    fork-per-release: "true"
    fork-per-release-periodic-interval: 1h 2h 6h 24h
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251021-e2c2c9806f-master
      command:
      - wrapper.sh
      - bash
      - -c
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/" && e2e-k8s.sh
      env:
      - name: LABEL_FILTER
        value: "Feature: isEmpty && !Slow && !Disruptive && !Flaky"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          cpu: 7

- interval: 1h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-ipv6
  annotations:
    testgrid-dashboards: sig-release-master-blocking, sig-testing-kind
    testgrid-tab-name: kind-ipv6-master
    description: Uses kubetest to run e2e tests for on-by-default features against a latest kubernetes master IPv6 cluster created with sigs.k8s.io/kind
    testgrid-alert-email: bentheelder@google.com,antonio.ojea.garcia@gmail.com,release-team@kubernetes.io
    testgrid-num-columns-recent: '6'
    fork-per-release: "true"
    fork-per-release-periodic-interval: 1h 2h 6h 24h
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251021-e2c2c9806f-master
      command:
      - wrapper.sh
      - bash
      - -c
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/" && e2e-k8s.sh
      env:
      # enable IPV6 in bootstrap image
      - name: DOCKER_IN_DOCKER_IPV6_ENABLED
        value: "true"
      # tell kind CI script to use ipv6
      - name: IP_FAMILY
        value: "ipv6"
      - name: LABEL_FILTER
        value: "Feature: isEmpty && !Slow && !Disruptive && !Flaky"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          # during the tests more like 3-20m is used
          cpu: 7

- interval: 4h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-beta-features
  annotations:
    testgrid-dashboards: sig-release-master-blocking, sig-testing-kind
    testgrid-tab-name: kind-master-beta-features
    description: Runs tests with no special requirements other than beta feature gates in a KinD cluster where beta feature gates and APIs are enabled.
    testgrid-alert-email: bentheelder@google.com,antonio.ojea.garcia@gmail.com,patrick.ohly@intel.com,release-team@kubernetes.io
    testgrid-num-columns-recent: '6'
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251021-e2c2c9806f-master
      command:
      - wrapper.sh
      - bash
      - -c
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/" && e2e-k8s.sh
      env:
      - name: FEATURE_GATES
        value: '{"AllBeta":true}'
      - name: RUNTIME_CONFIG
        value: '{"api/beta":"true", "api/ga":"true"}'
      - name: LABEL_FILTER
        value: "Feature: isSubsetOf OffByDefault && !Alpha && !Deprecated && !Slow && !Disruptive && !Flaky"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          cpu: 7

- interval: 4h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-beta-enabled
  annotations:
    testgrid-dashboards: sig-testing-kind
    testgrid-tab-name: kind-master-beta-enabled
    description: Runs tests with no special requirements in a KinD cluster where beta feature gates and APIs are enabled, i.e. this does not include tests for off-by-default beta features.
    testgrid-alert-email: bentheelder@google.com,antonio.ojea.garcia@gmail.com,patrick.ohly@intel.com
    testgrid-num-columns-recent: '6'
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251021-e2c2c9806f-master
      command:
      - wrapper.sh
      - bash
      - -c
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/" && e2e-k8s.sh
      env:
      - name: FEATURE_GATES
        value: '{"AllBeta":true}'
      - name: RUNTIME_CONFIG
        value: '{"api/beta":"true", "api/ga":"true"}'
      - name: LABEL_FILTER
        value: "Feature: isEmpty && !Alpha && !Deprecated && !Slow && !Disruptive && !Flaky"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          cpu: 7

- interval: 4h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-beta-enabled-conformance
  annotations:
    testgrid-dashboards: sig-testing-kind
    testgrid-tab-name: kind-master-beta-enabled-conformance
    description: Runs conformance tests in a KinD cluster where beta feature gates and APIs are enabled.
    testgrid-alert-email: bentheelder@google.com,antonio.ojea.garcia@gmail.com,patrick.ohly@intel.com
    testgrid-num-columns-recent: '6'
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251021-e2c2c9806f-master
      command:
      - wrapper.sh
      - bash
      - -c
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/" && e2e-k8s.sh
      env:
      - name: FEATURE_GATES
        value: '{"AllBeta":true}'
      - name: RUNTIME_CONFIG
        value: '{"api/beta":"true", "api/ga":"true"}'
      - name: LABEL_FILTER
        value: "Conformance && !Deprecated && !Slow && !Disruptive && !Flaky"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          cpu: 7

- interval: 4h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-alpha-beta-features
  annotations:
    testgrid-dashboards: sig-release-master-informing, sig-testing-kind
    testgrid-tab-name: kind-master-alpha-beta-features
    description: Runs tests with no special requirements other than alpha or beta feature gates in a KinD cluster where alpha and beta feature gates and APIs are enabled.
    testgrid-alert-email: bentheelder@google.com,antonio.ojea.garcia@gmail.com,patrick.ohly@intel.com,release-team@kubernetes.io
    testgrid-num-columns-recent: '6'
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251021-e2c2c9806f-master
      command:
      - wrapper.sh
      - bash
      - -c
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/" && e2e-k8s.sh
      env:
        # EventedPLEG is disabled temporarily for https://github.com/kubernetes/kubernetes/issues/122721
      - name: FEATURE_GATES
        value: '{"AllAlpha":true,"AllBeta":true,"EventedPLEG": false}'
      - name: RUNTIME_CONFIG
        value: '{"api/all":"true"}'
      - name: LABEL_FILTER
        value: "Feature: isSubsetOf OffByDefault && !Deprecated && !Slow && !Disruptive && !Flaky"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          cpu: 7

- interval: 8h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-alpha-beta-features-canary
  annotations:
    testgrid-dashboards: sig-testing-kind
    testgrid-tab-name: kind-master-alpha-beta-features-canary
    description: Runs tests with no special requirements other than alpha or beta feature gates in a KinD cluster where alpha and beta feature gates and APIs are enabled. In contrast to ci-kubernetes-e2e-kind-alpha-beta-features it really runs all such tests, with serial and flaky tests being the only exceptions.
    testgrid-alert-email: patrick.ohly@intel.com
    testgrid-num-columns-recent: '6'
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 2h
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251021-e2c2c9806f-master
      command:
      - wrapper.sh
      - bash
      - -c
      # Modified e2e-k8s.sh from https://github.com/kubernetes-sigs/kind/pull/4015/files.
      # It gets pulled here to try out that modification for a while *before* merging it.
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/" && curl -sSLO https://raw.githubusercontent.com/pohly/kind/46d774ce34846c9522efd9de1150b0d3cfa585c8/hack/ci/e2e-k8s.sh && chmod u+x e2e-k8s.sh && ./e2e-k8s.sh
      env:
      - name: FEATURE_GATES
        value: '{"AllAlpha":true,"AllBeta":true,"EventedPLEG": false}'
      - name: RUNTIME_CONFIG
        value: '{"api/all":"true"}'
      - name: LABEL_FILTER
        # Full coverage. The only exception are known flaky tests
        # and deprecated features because those don't get enabled by AllAlpha/Beta.
        #
        # Serial tests get disabled temporarily to make it more comparable with ci-kubernetes-e2e-kind-alpha-beta-features
        # (https://github.com/onsi/ginkgo/issues/1599#issuecomment-3441247598) and could be enabled again later.
        value: "Feature: isSubsetOf OffByDefault && !Deprecated && !Flaky && !Serial"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          cpu: 7

- interval: 4h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-alpha-beta-enabled
  annotations:
    testgrid-dashboards: sig-testing-kind
    testgrid-tab-name: kind-master-alpha-beta-enabled
    description: Runs tests with no special requirements in a KinD cluster where alpha and beta feature gates and APIs are enabled, i.e. this does not include tests for alpha features and off-by-default beta features.
    testgrid-alert-email: bentheelder@google.com,antonio.ojea.garcia@gmail.com,patrick.ohly@intel.com
    testgrid-num-columns-recent: '6'
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251021-e2c2c9806f-master
      command:
      - wrapper.sh
      - bash
      - -c
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/" && e2e-k8s.sh
      env:
        # EventedPLEG is disabled temporarily for https://github.com/kubernetes/kubernetes/issues/122721
      - name: FEATURE_GATES
        value: '{"AllAlpha":true,"AllBeta":true,"EventedPLEG": false}'
      - name: RUNTIME_CONFIG
        value: '{"api/all":"true"}'
      - name: LABEL_FILTER
        value: "Feature: isEmpty && !Deprecated && !Slow && !Disruptive && !Flaky"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          cpu: 7

- interval: 4h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-alpha-beta-conformance
  annotations:
    testgrid-dashboards: sig-testing-kind
    testgrid-tab-name: kind-master-alpha-beta-enabled-conformance
    description: Runs conformance tests in a KinD cluster where alpha and beta feature gates and APIs are enabled.
    testgrid-alert-email: bentheelder@google.com,antonio.ojea.garcia@gmail.com,patrick.ohly@intel.com
    testgrid-num-columns-recent: '6'
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251021-e2c2c9806f-master
      command:
      - wrapper.sh
      - bash
      - -c
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/" && e2e-k8s.sh
      env:
        # EventedPLEG is disabled temporarily for https://github.com/kubernetes/kubernetes/issues/122721
      - name: FEATURE_GATES
        value: '{"AllAlpha":true,"AllBeta":true,"EventedPLEG": false}'
      - name: RUNTIME_CONFIG
        value: '{"api/all":"true"}'
      - name: LABEL_FILTER
        value: "Conformance && !Deprecated && !Slow && !Disruptive && !Flaky"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          cpu: 7

- interval: 24h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-rootless
  annotations:
    testgrid-dashboards: sig-testing-kind
    testgrid-tab-name: kind-rootless
    description: Kubernetes in Rootless Docker (in GCE VM)
    # GitHub ID: @AkihiroSuda
    testgrid-alert-email: suda.kyoto@gmail.com
    testgrid-num-columns-recent: '6'
  labels:
    preset-service-account: "true"
    preset-k8s-ssh: "true"
  decorate: true
  decoration_config:
    timeout: 90m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/kubekins-e2e:v20251021-e2c2c9806f-master
      command:
      - runner.sh
      args:
      - /bin/bash
      - -c
      - |
        set -eux
        # kindinv: Kubernetes in (Rootless) Docker in (GCE) VM
        # See https://github.com/rootless-containers/kubetest2-kindinv
        #
        # GCE VM is used for setting up cgroup v2 and systemd.
        # (k8s-infra-prow-build lacks cgroup v2, and the kubekins-e2e container lacks systemd)
        (cd ; GO111MODULE=on go install github.com/rootless-containers/kubetest2-kindinv@master)
        mkdir -p -m 0700 ~/.ssh
        cp -f "${GCE_SSH_PRIVATE_KEY_FILE}" ~/.ssh/google_compute_engine
        cp -f "${GCE_SSH_PUBLIC_KEY_FILE}" ~/.ssh/google_compute_engine.pub
        exec kubetest2 kindinv \
          --boskos-location=http://boskos.test-pods.svc.cluster.local \
          --gcp-zone=us-central1-b \
          --instance-image=ubuntu-os-cloud/ubuntu-2404-lts-amd64 \
          --instance-type=n2-standard-4 \
          --kind-rootless \
          --user=rootless \
          --build \
          --up \
          --down \
          --test=ginkgo \
          -- \
          --use-built-binaries \
          --focus-regex='\[NodeConformance\]' \
          --skip-regex='\[Environment:NotInUserNS\]|\[Slow\]' \
          --parallel=8
      resources:
        limits:
          memory: 2Gi
          cpu: 2
        requests:
          memory: 2Gi
          cpu: 2
  rerun_auth_config:
    allow_anyone: true
- interval: 24h
  cluster: k8s-infra-prow-build
  name: ci-kubernetes-e2e-kind-arm64
  annotations:
    testgrid-dashboards: sig-testing-kind
    testgrid-tab-name: kind-master-arm64
    description: Runs e2e tests against a latest kubernetes master created with sigs.k8s.io/kind using arm64
    testgrid-alert-email: bentheelder@google.com,antonio.ojea.garcia@gmail.com, davanum@gmail.com
    testgrid-num-columns-recent: '6'
  labels:
    preset-dind-enabled: "true"
  decorate: true
  decoration_config:
    timeout: 60m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  spec:
    containers:
    - image: us-central1-docker.pkg.dev/k8s-staging-test-infra/images/kubekins-e2e:v20251021-e2c2c9806f-master
      command:
      - runner.sh
      args:
      - bash
      - -c
      - curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-arm64.tgz | tar xvfz - -C "${PATH%%:*}/" && e2e-k8s.sh
      env:
      - name: LABEL_FILTER
        value: "Feature: isEmpty && !Slow && !Disruptive && !Flaky"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          memory: 9Gi
          cpu: 7
        requests:
          # these are both a bit below peak usage during build
          # this is mostly for building kubernetes
          memory: 9Gi
          cpu: 7
    nodeSelector:
      kubernetes.io/arch: arm64
