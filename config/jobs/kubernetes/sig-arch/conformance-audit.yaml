presubmits:
  kubernetes/kubernetes:
    # same as ci-kubernetes-audit-kind-conformance, but a presubmit job
    - name: pull-kubernetes-audit-kind-conformance
      cluster: k8s-infra-prow-build
      optional: true
      always_run: false
      run_if_changed: '^(test/conformance/testdata/|api/openapi-spec/)'
      decorate: true
      skip_branches:
        - release-\d+\.\d+ # per-release settings
      labels:
        preset-service-account: "true"
        preset-dind-enabled: "true"
        preset-kind-volume-mounts: "true"
      decoration_config:
        timeout: 150m
        grace_period: 15m
      path_alias: k8s.io/kubernetes
      extra_refs:
        - org: kubernetes
          repo: test-infra
          base_ref: master
          path_alias: k8s.io/test-infra
      spec:
        containers:
          - image: gcr.io/k8s-staging-test-infra/krte:v20251210-5e6349e4b2-master
            command:
              - wrapper.sh
              - bash
              - -c
              -
                  curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/"
                  && curl -sO https://raw.githubusercontent.com/ii/kind/ci-audit-logging/hack/ci/e2e-k8s.sh
                  && bash e2e-k8s.sh
                  && apt-get update && apt-get install -y --no-install-recommends python3-pip && pip3 install --no-cache-dir --break-system-packages pyyaml
                  && python3 ./../test-infra/experiment/audit/audit_log_parser.py --audit-logs ${ARTIFACTS}/audit/audit*.log --output "${ARTIFACTS}/audit/audit-endpoints.txt" --audit-operations-json "${ARTIFACTS}/audit/audit-operations.json" --swagger-url "file://$PWD/api/openapi-spec/swagger.json" --ineligible-endpoints-url "file://$PWD/test/conformance/testdata/ineligible_endpoints.yaml" --pending-eligible-endpoints-url "file://$PWD/test/conformance/testdata/pending_eligible_endpoints.yaml"
                  && python3 ./../test-infra/experiment/audit/kubernetes_api_analysis.py --pull-audit-endpoints "${ARTIFACTS}/audit/audit-endpoints.txt" --swagger-url "file://$PWD/api/openapi-spec/swagger.json"
            env:
              - name: BUILD_TYPE
                value: docker
            # we need privileged mode in order to do docker in docker
            securityContext:
              privileged: true
            resources:
              # these are both a bit below peak usage during build
              # this is mostly for building kubernetes
              limits:
                cpu: 2000m
                memory: "9000Mi"
              requests:
                # during the tests more like 3-20m is used
                cpu: 2000m
                memory: "9000Mi"
      annotations:
        testgrid-dashboards: sig-arch-conformance
        testgrid-tab-name: presubmit-kind-conformance-audit
        testgrid-alert-email: kubernetes-sig-arch-conformance-test-failures@googlegroups.com, davanum@gmail.com
        testgrid-num-failures-to-alert: '1'

periodics:
# conformance test against kubernetes master branch with `kind` and auditlogs
# Other than annotations and modified ci-audit-logging e2e-k8s.sh
# This should be the same as ci-kubernetes-kind-conformance
- interval: 3h
  name: ci-kubernetes-audit-kind-conformance
  cluster: k8s-infra-prow-build
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-kind-volume-mounts: "true"
  decorate: true
  decoration_config:
    timeout: 150m
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  - org: kubernetes
    repo: test-infra
    base_ref: master
    path_alias: k8s.io/test-infra
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251210-5e6349e4b2-master
      command:
        - wrapper.sh
        - bash
        - -c
        -
            curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/"
            && curl -sO https://raw.githubusercontent.com/ii/kind/ci-audit-logging/hack/ci/e2e-k8s.sh
            && bash e2e-k8s.sh
            && apt-get update && apt-get install -y --no-install-recommends python3-pip && pip3 install --no-cache-dir --break-system-packages pyyaml
            && python3 ./../test-infra/experiment/audit/audit_log_parser.py --audit-logs ${ARTIFACTS}/audit/audit*.log --output "${ARTIFACTS}/audit/audit-endpoints.txt" --audit-operations-json "${ARTIFACTS}/audit/audit-operations.json" --swagger-url "file://$PWD/api/openapi-spec/swagger.json"
      env:
      - name: BUILD_TYPE
        value: docker
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        # these are both a bit below peak usage during build
        # this is mostly for building kubernetes
        limits:
          cpu: 2000m
          memory: "9000Mi"
        requests:
          # during the tests more like 3-20m is used
          cpu: 2000m
          memory: "9000Mi"
  annotations:
    testgrid-dashboards: sig-arch-conformance
    testgrid-tab-name: kind-conformance-audit
    testgrid-alert-email: kubernetes-sig-arch-conformance-test-failures@googlegroups.com, davanum@gmail.com
    testgrid-num-failures-to-alert: '1'
    description: 'Uses patched ci-kubernetes-kind-conformance job to generate ARTIFACT/audit/audit.log'

# E2E tests against kubernetes master branch with `kind` and audit logs enabled.
# This job mirrors ci-kubernetes-e2e-gci-gce test coverage but runs on KIND with audit logging.
# Uses the standard kind e2e-k8s.sh script with audit logging injected via wrapper.
#
# Serial tests are included (not skipped) because Ginkgo v2 handles them automatically:
# parallel specs run first, then Serial specs run on process #1 after all others complete.
# This provides better API coverage for audit analysis.
# See: https://onsi.github.io/ginkgo/#serial-specs
- interval: 3h
  name: ci-kubernetes-e2e-kind-audit
  cluster: k8s-infra-prow-build
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-kind-volume-mounts: "true"
  decorate: true
  decoration_config:
    timeout: 300m  # Increased to accommodate Serial tests running after parallel tests
  extra_refs:
  - org: kubernetes
    repo: kubernetes
    base_ref: master
    path_alias: k8s.io/kubernetes
  - org: kubernetes
    repo: test-infra
    base_ref: master
    path_alias: k8s.io/test-infra
  spec:
    containers:
    - image: gcr.io/k8s-staging-test-infra/krte:v20251210-5e6349e4b2-master
      command:
        - wrapper.sh
        - bash
        - -c
        - |
            set -o errexit
            set -o nounset
            set -o pipefail

            # Install kind
            curl -sSL https://kind.sigs.k8s.io/dl/latest/linux-amd64.tgz | tar xvfz - -C "${PATH%%:*}/"

            # Create audit policy for capturing API calls
            mkdir -p "${ARTIFACTS}/audit"
            cat > "${ARTIFACTS}/audit/policy.yaml" << 'AUDIT_POLICY'
            apiVersion: audit.k8s.io/v1
            kind: Policy
            rules:
              - level: Metadata
                stages:
                  - ResponseComplete
            AUDIT_POLICY

            # Download standard kind e2e script
            curl -sSLo e2e-k8s.sh https://raw.githubusercontent.com/kubernetes-sigs/kind/main/hack/ci/e2e-k8s.sh

            # Patch the script to inject audit logging into the kind config
            # This adds audit policy and log path to the API server configuration
            sed -i '/kubeadmConfigPatches:/a\
            - |\
              kind: ClusterConfiguration\
              apiServer:\
                extraArgs:\
                  audit-policy-file: /etc/kubernetes/audit/policy.yaml\
                  audit-log-path: /var/log/kubernetes/audit.log\
                  audit-log-maxage: "0"\
                  audit-log-maxbackup: "0"\
                  audit-log-maxsize: "2000000000"\
                extraVolumes:\
                - name: audit-policy\
                  hostPath: /audit/policy.yaml\
                  mountPath: /etc/kubernetes/audit/policy.yaml\
                  readOnly: true\
                - name: audit-logs\
                  hostPath: /audit\
                  mountPath: /var/log/kubernetes\
                  readOnly: false' e2e-k8s.sh

            # Add extraMounts to the existing control-plane node to mount audit policy
            sed -i '/- role: control-plane$/a\
              extraMounts:\
              - hostPath: '"${ARTIFACTS}"'/audit\
                containerPath: /audit' e2e-k8s.sh

            # Run the e2e tests
            chmod +x e2e-k8s.sh
            ./e2e-k8s.sh

            # Copy audit logs from kind node to artifacts
            docker cp kind-control-plane:/var/log/kubernetes/audit.log "${ARTIFACTS}/audit/" || true

            # Parse audit logs
            apt-get update && apt-get install -y --no-install-recommends python3-pip
            pip3 install --no-cache-dir --break-system-packages pyyaml
            python3 ./../test-infra/experiment/audit/audit_log_parser.py \
              --audit-logs "${ARTIFACTS}/audit/audit.log" \
              --output "${ARTIFACTS}/audit/audit-endpoints.txt" \
              --audit-operations-json "${ARTIFACTS}/audit/audit-operations.json" \
              --swagger-url "file://$PWD/api/openapi-spec/swagger.json" \
              --ineligible-endpoints-url "file://$PWD/test/conformance/testdata/ineligible_endpoints.yaml" \
              --pending-eligible-endpoints-url "file://$PWD/test/conformance/testdata/pending_eligible_endpoints.yaml"
            python3 ./../test-infra/experiment/audit/kubernetes_api_analysis.py \
              --pull-audit-endpoints "${ARTIFACTS}/audit/audit-endpoints.txt" \
              --swagger-url "file://$PWD/api/openapi-spec/swagger.json"
      env:
      - name: BUILD_TYPE
        value: docker
      # FOCUS="" overrides the default [Conformance] focus to run all tests
      - name: FOCUS
        value: ""
      # Skip: Driver:gcepd (GCE-specific), Slow, Disruptive, Flaky, Feature tests
      # Note: Serial tests are NOT skipped - Ginkgo v2 runs them automatically
      # after parallel tests complete, providing better API coverage for auditing.
      - name: SKIP
        value: "\\[Driver:.gcepd\\]|\\[Slow\\]|\\[Disruptive\\]|\\[Flaky\\]|\\[Feature:.+\\]"
      - name: PARALLEL
        value: "true"
      # we need privileged mode in order to do docker in docker
      securityContext:
        privileged: true
      resources:
        limits:
          cpu: 7
          memory: "9Gi"
        requests:
          cpu: 7
          memory: "9Gi"
  annotations:
    testgrid-dashboards: sig-arch-conformance, sig-testing-kind
    testgrid-tab-name: kind-e2e-audit
    testgrid-alert-email: kubernetes-sig-arch-conformance-test-failures@googlegroups.com
    testgrid-num-failures-to-alert: '3'
    description: 'Runs E2E tests on KIND with audit logging for API coverage analysis. Includes Serial tests for comprehensive endpoint coverage.'
