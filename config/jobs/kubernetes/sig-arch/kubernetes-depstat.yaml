presubmits:
  kubernetes/kubernetes:
  - name: check-dependency-stats
    cluster: eks-prow-build-cluster
    decorate: true
    decoration_config:
      timeout: 10m
    path_alias: k8s.io/kubernetes
    always_run: false
    optional: true
    run_if_changed: '^(go.mod|go.sum|vendor)'
    spec:
      containers:
      - image: golang
        command:
        - /bin/bash
        args:
        - -c
        - |
          set -euo pipefail

          export WORKDIR=${ARTIFACTS:-$TMPDIR}
          export PATH=$PATH:$GOPATH/bin
          export GOWORK=off

          mkdir -p "${WORKDIR}"
          pushd "$WORKDIR"
          go install github.com/kubernetes-sigs/depstat@latest
          popd

          # Install graphviz and jq
          apt-get update -qq && apt-get install -y -qq graphviz jq > /dev/null 2>&1

          MAIN_MODULES="k8s.io/kubernetes$(ls staging/src/k8s.io | awk '{printf ",k8s.io/" $0}')"

          echo "=== Dependency Diff: ${PULL_BASE_SHA}..HEAD ==="
          echo ""

          # Generate dependency diff (text output with split-test-only)
          depstat diff "${PULL_BASE_SHA}" HEAD -m "${MAIN_MODULES}" -v --split-test-only | tee "${WORKDIR}/diff.txt"

          # Generate JSON for programmatic consumption (includes split test-only/non-test sections)
          depstat diff "${PULL_BASE_SHA}" HEAD -m "${MAIN_MODULES}" --split-test-only --json > "${WORKDIR}/diff.json"

          # Generate DOT and SVG visualization of changes
          depstat diff "${PULL_BASE_SHA}" HEAD -m "${MAIN_MODULES}" --dot > "${WORKDIR}/diff.dot"
          dot -Tsvg "${WORKDIR}/diff.dot" -o "${WORKDIR}/diff.svg"

          # Show why each new dependency was added
          ADDED_DEPS=$(jq -r '.added[]?' "${WORKDIR}/diff.json" 2>/dev/null || true)
          if [ -n "${ADDED_DEPS}" ]; then
            echo ""
            echo "=== Why new dependencies are included ==="
            for dep in ${ADDED_DEPS}; do
              echo ""
              echo "--- ${dep} ---"
              depstat why "${dep}" -m "${MAIN_MODULES}" 2>/dev/null || echo "  (could not trace dependency path)"
            done | tee "${WORKDIR}/why-added.txt"
          fi

          # Summarize test-only vs non-test changes
          echo ""
          echo "=== Test-only vs Non-test dependency changes ==="
          jq -r '"Non-test added: \(.split.nonTestOnly.added // [] | length), removed: \(.split.nonTestOnly.removed // [] | length)"' "${WORKDIR}/diff.json"
          jq -r '"Test-only added: \(.split.testOnly.added // [] | length), removed: \(.split.testOnly.removed // [] | length)"' "${WORKDIR}/diff.json"

          echo ""
          echo "Artifacts saved to: ${WORKDIR}"
          echo "  - diff.txt: Human-readable diff with test-only split"
          echo "  - diff.json: Machine-readable diff (includes .split.testOnly and .split.nonTestOnly)"
          echo "  - diff.svg: Visual dependency change graph"
        resources:
          requests:
            memory: 4Gi
            cpu: 2
          limits:
            memory: 4Gi
            cpu: 2
    annotations:
      testgrid-create-test-group: "true"
      testgrid-dashboards: sig-arch-code-organization
      testgrid-alert-email: davanum@gmail.com
      description: Generates dependency diff with visualization showing added/removed dependencies
